name: Regenerate and Check

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  regenerate-and-check:
    name: Regenerate & Android smoke check
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Make helper script executable
        run: chmod +x ./scripts/regenerate_and_check.sh

      - name: Run regenerate_and_check.sh
        id: regen
        run: |
          set -o pipefail
          mkdir -p build/logs
          ./scripts/regenerate_and_check.sh 2>&1 | tee build/logs/regenerate_and_check.log

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: regenerate-and-check-logs
          path: |
            build/logs/regenerate_and_check.log
            Android/build/reports/problems
            Android/build/reports/tests || true

      - name: Clean workspace to avoid leaving derived files
        if: ${{ always() }}
        run: |
          rm -rf /Users/runner/Library/Developer/Xcode/DerivedData/* || true

    timeout-minutes: 40
   
# Notes:
# - This workflow runs the existing `scripts/regenerate_and_check.sh` on macOS,
#   which performs the Xcode build/transpile and an Android Kotlin compile smoke test.
# - On failures the job uploads log artifacts for inspection.
# - If you'd like, we can add a separate Linux job to run additional Android tasks (assemble, tests) and/or collect coverage reports.